# デプロイ / 更新ガイド（本番・検証・トラブルシュート）

このドキュメントは、Web Dcloud Server のデプロイ／更新作業を安全に実施するための手順と、環境別運用（本番/検証）、既知エラーの対処方法をまとめたものです。想定構成は「nginx リバースプロキシ + systemd + Python venv」です。

# 前提

- Python 3.9+ と仮想環境（python -m venv venv）
- このリポジトリを /path/to/Web_Discord_Server に配置
- .env に必要変数を設定済み（README.md 参照）
- nginx は 127.0.0.1:9040 にプロキシ（例は 資料_nginxについて.md）

# 環境別運用（本番/検証）
- BOT_GUILD_ID: 開発・検証環境では対象ギルド ID を設定し、スラッシュコマンドの同期を限定します。本番は未設定（グローバル同期）か本番ギルド ID にします。
- PUBLIC_DOMAIN: 環境ごとのドメインを設定（例: stg.example.com / files.example.com）。
- OAuth リダイレクト:
    - Google: https://<PUBLIC_DOMAIN>/gdrive_callback
    - Discord: https://<PUBLIC_DOMAIN>/discord_callback
    - 検証→本番切替時は、クラウドコンソール側の許可リダイレクト URL と .env の PUBLIC_DOMAIN を同時に整合させます。
- .env は環境別に用意（例: .env.stg / .env.prod）。systemd の EnvironmentFile= で切り替えると安全です。

# 更新手順
以下は一般的な更新フローです。DB スキーマは起動時に自動マイグレーション（init_db）されますが、更新前に必ずバックアップを取得してください。

 1.メンテナンス告知（必要に応じて）

 2.事前バックアップ

 - DB: ``` bash  sqlite3 /path/to/data/web_discord_server.db ".backup '/backups/wds-$(date +%F-%H%M).db'" ```
 - 設定類: .env, nginx 設定, OAuth 秘密鍵/トークンを保全

 1.コード取得・依存更新（仮想環境内）
 ```bash
 cd /path/to/Web_Discord_Server
# 任意: 現行リリースの記録
git rev-parse --short HEAD > /backups/wds-prev-commit.txt

git fetch --all --tags
# 例: 安定ブランチ/タグへ更新
git checkout main && git pull --ff-only
source venv/bin/activate
pip install -U pip
pip install -r requirements.txt
 ```
 1.アプリ再起動とヘルス確認（ダウンタイムありのシンプル方式）
 ```bash
 sudo systemctl restart web_dcloud_server
# バックエンド直接
curl -fsS http://127.0.0.1:9040/health
# 経路含め
curl -fsS https://<PUBLIC_DOMAIN>/health

 ```
- 正常応答（{"status":"ok"}）を確認。エラー時は journalctl -u web_dcloud_server -e を確認。

# 準ゼロダウンタイムの案（Web 層のみ）

Discord Bot はトークン重複接続ができないため完全なゼロダウンタイムは困難です。Web だけ先行切替してダウンタイムを最小化する方法を示します。

- 新版 Web を別ポートで起動（PORT=9041 python web/app.py）
- DB マイグレーションは Web 起動時にも実施されます
- nginx の proxy_pass を 127.0.0.1:9041 へ切替し nginx -s reload
- 最後に Bot を短時間停止→更新→再起動

# ロールバック手順

 1.直前コミットへ戻す
 ```bash
cd /path/to/Web_Discord_Server
PREV=$(cat /backups/wds-prev-commit.txt)   # 事前に保存していれば
[ -n "$PREV" ] && git checkout "$PREV" || git checkout HEAD~1
pip install -r requirements.txt
sudo systemctl restart web_dcloud_server
 ```
 1.それでも不整合が出る場合は DB をバックアップ版に戻す（影響を理解したうえで実施）
 ```bash
sudo systemctl stop web_dcloud_server
cp /backups/wds-YYYY-mm-dd-HHMM.db /path/to/data/web_discord_server.db
sudo systemctl start web_dcloud_server
 ```

# ヘルス確認チェックリスト
- GET /health が 200 + {"status":"ok"}
- ログインページ表示・CSRF 発行（/csrf_token が 200）
- ファイル一覧/アップロード/ダウンロード（小さいファイルで疎通）
- 共有リンク発行→期限切れ処理の動作
- Discord スラッシュコマンド同期（検証環境では BOT_GUILD_ID を利用）

# 既知エラーのトラブルシュート
- COOKIE_SECRET 桁数エラー

    - 症状: COOKIE_SECRET が未設定、または 44 文字の URL-safe Base64 ではありません（web/app.py:66 付近）
    - 対処: 32 バイトの乱数を URL-safe Base64 で生成し .env に設定（44 文字）

```lua
python - <<'PY'
import os, base64
print(base64.urlsafe_b64encode(os.urandom(32)).decode())
PY
```
- 注意: 値を変えると既存セッションは無効化
- OAuth リダイレクト不一致（Google/Discord で 400）

    - PUBLIC_DOMAIN と許可リダイレクト URL を一致
    - Google: https://<PUBLIC_DOMAIN>/gdrive_callback
    - Discord: https://<PUBLIC_DOMAIN>/discord_callback
    - HTTPS 動作・証明書・nginx のリダイレクト設定を確認
- 大容量アップロードで 413/504/タイムアウト

    - nginx の client_max_body_size を十分に大きく（例: 50G）
    - proxy_request_buffering off; proxy_buffering off;
    - proxy_read_timeout/proxy_send_timeout を長めに
    - HTTP/HTTPS 両 vhost で同様に設定（資料_nginxについて.md）
- Discord DM が届かない（DM 拒否）

    - ユーザー側の「サーバーメンバーからの DM を許可」がオフ
    - 設定変更→コマンド再実行（例: /resend_login があれば再送）
    - Web UI からリンク確認できる運用を用意
    - 連続送信は SEND_INTERVAL_SEC により制限（既定 60 秒）
- 502/接続不可（再起動直後）

    - journalctl -u web_dcloud_server -e を確認
    - COOKIE_SECRET や環境変数の取り違え、ポート競合（9040 重複）を確認

# 付録: 最小構成の systemd unit 例

```ini
# /etc/systemd/system/web_dcloud_server.service
[Unit]
Description=Web Dcloud Server
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
WorkingDirectory=/path/to/Web_Discord_Server
EnvironmentFile=/path/to/Web_Discord_Server/.env
ExecStart=/path/to/Web_Discord_Server/venv/bin/python bot/bot.py
Restart=always
RestartSec=3
# 大きめの FD が必要な場合
LimitNOFILE=65536
# ログは journald に送る。必要なら LOG_LEVEL を .env で渡す

[Install]
WantedBy=multi-user.target
```
- journald からログ確認: journalctl -u web_dcloud_server -f
- 環境別に .env.stg/.env.prod を作成し、EnvironmentFile を切り替えて運用