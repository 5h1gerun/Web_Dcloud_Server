{% extends "base.html" %}
{% block title %}パスキー登録 | Web-Discord-Server{% endblock %}
{% block content %}
<div class="form-check form-switch position-fixed top-0 end-0 m-3 text-white">
  <input class="form-check-input" type="checkbox" id="darkModeSwitch">
  <label class="form-check-label" for="darkModeSwitch">🌙</label>
</div>
<div class="d-flex justify-content-center align-items-center" style="min-height: 100vh;">
  <div class="card p-4 shadow-2-strong animate__animated animate__fadeIn" style="width: 100%; max-width: 400px;">
    <h2 class="text-center mb-4 fw-bold text-primary">Register Passkey</h2>
    <div id="msg" class="alert d-none" role="alert"></div>
    <button id="reg-passkey" class="btn btn-primary btn-lg w-100 ripple" data-mdb-ripple-init>
      <i class="bi bi-key me-2"></i>Register
    </button>
  </div>
</div>
<script>
const btn = document.getElementById('reg-passkey');
btn.addEventListener('click', async () => {
  try {
    const res = await fetch('/register_passkey_begin');
    const opts = await res.json();
    opts.challenge = Uint8Array.from(atob(opts.challenge), c => c.charCodeAt(0));
    const cred = await navigator.credentials.create({publicKey: opts});
    const data = {
      id: cred.id,
      rawId: btoa(String.fromCharCode(...new Uint8Array(cred.rawId))),
      type: cred.type,
      response: {
        attestationObject: btoa(String.fromCharCode(...new Uint8Array(cred.response.attestationObject))),
        clientDataJSON: btoa(String.fromCharCode(...new Uint8Array(cred.response.clientDataJSON)))
      }
    };
    const verify = await fetch('/register_passkey_finish', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
    if (verify.ok) {
      const div = document.getElementById('msg');
      div.className = 'alert alert-success';
      div.textContent = '登録しました';
      div.classList.remove('d-none');
    } else {
      throw new Error();
    }
  } catch(e) {
    const div = document.getElementById('msg');
    div.className = 'alert alert-danger';
    div.textContent = '登録に失敗しました';
    div.classList.remove('d-none');
  }
});
</script>
{% endblock %}
