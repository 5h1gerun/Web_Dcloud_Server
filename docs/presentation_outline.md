# Web Discord Server プレゼン用まとめ

本ドキュメントは、PowerPoint で本システムを紹介する際の要点を箇条書きで整理したものです。

## システム概要
- Discord ボットと aiohttp 製 Web サーバーを統合したファイル共有システム
  - ボットが起動すると Web サーバーも同時に開始し、アップロード済みファイルをブラウザから閲覧・ダウンロード可能
  - 各処理は非同期に実行されるため、ボットの反応速度を損なわない
- Gemini API を利用した自動タグ付け機能
  - Office 文書や PDF、画像ファイルなど多様な形式を解析し、キーワードを抽出
  - 非対応形式はテキストへ変換した上でタグ生成を試みる
  - 生成されたタグはデータベースに保存され、後述の検索機能に利用

## 主な機能
- ボットコマンドによるファイル操作
  - `/upload` でファイル送信、`/myfiles` で自分のアップロード一覧を表示
  - `/rename` などの補助コマンドでメタデータ編集も可能
- Google Drive 連携
  - アップロード時に Drive へ自動コピーし、リンク切れを防止
  - `/gdrive_import` を使えば Drive 上のファイルを指定して取り込み可能
- Web UI の豊富な機能
  - サムネイル表示付きダウンロード、タグ検索、共有リンク生成
  - オフライン時もキャッシュから閲覧でき、Push API で更新通知を受信
- モバイル向け機能
  - QR コードを用いたログイン、スマホからのワンタップダウンロード
  - 共有フォルダでは Webhook 経由でアップロード通知を送信

## セキュリティ対策
- パスワードは scrypt でハッシュ化し、二要素認証 (TOTP) を任意で利用
  - TOTP 秘密鍵は QR コードで配布し、スマホ認証アプリで管理
- HMAC 付きダウンロードリンクに有効期限を設け、CSRF トークン検証を実施
  - 署名と有効期限をチェックし、改ざんやリプレイを防止
- IP 単位のレートリミットや Content-Security-Policy ヘッダーを設定
  - `FORCE_HTTPS=1` で常に HTTPS にリダイレクト可能
  - アップロード時にはファイルの SHA256 ハッシュも保存して改ざん検知

## アーキテクチャ
- Bot と Web サーバー、SQLite データベース、ファイルストレージが連携
  - ボットはアップロード受付後に非同期でファイル保存と Drive へのコピーを実施
  - メタデータは SQLite に集約し、検索や履歴管理に利用
- Gemini API との連携
  - ファイルアップロード直後にバックグラウンドでタグ生成タスクを起動
  - Drive 連携時は OAuth 認証を通じてアクセストークンを取得
- サービスワーカーが静的ファイルをキャッシュし、オフライン時は `/offline` ページを表示
  - Push 通知により新着ファイルを即時に知らせる

## 運用・環境
- Python 3.9 以上で動作し、主要ライブラリは `requirements.txt` で指定
  - `pip install -r requirements.txt` で簡単にセットアップ可能
- `.env` ファイルで Discord トークンや各種 API キー、ポート番号などを設定
  - `DATA_DIR` や `STATIC_DIR` など運用に合わせたパスを指定
- Raspberry Pi 5 + SSD 環境で確認済み。リバースプロキシには nginx を使用
  - Ubuntu 系ディストリビューションでも同様の手順で導入可能

## 参考資料
- `docs/architecture.mmd` : システム全体図
- `docs/sequence_system.mmd` : 一連の処理シーケンス
- `docs/sequence_discord.mmd` : Discord 上での流れ
- `docs/sequence_web.mmd` : Web サーバーでのやり取り
- `docs/sequence_pwa.mmd` : PWA の動作シーン
  - 各ファイルは Mermaid 形式で記述され、Graphviz 等でビジュアル化可能

以上をスライドにまとめることで、システムの全体像と特徴を効果的に伝えられます。
